<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Currency Converter</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        
        .main-container {
            width: 100%;
            max-width: 900px;
        }
        
        /* Tables */
        table {
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        
        th, td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
        }
        
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
            width: 100%;
        }
        
        /* Form elements */
        input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .save-btn {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .save-btn:hover {
            background-color: #45a049;
        }
        
        /* Tab styles */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            background-color: white;
            border-radius: 0 0 4px 4px;
            animation: fadeEffect 1s;
        }
        
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        /* TOM Calculator styles */
        .config-container {
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .formula-display {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            font-family: monospace;
        }
        
        .saved-row {
            background-color: #f0f0f0;
        }
        
        .in-stock-row td {
            background-color: #e8f5e9;
        }
        
        .pre-order-row td {
            background-color: #fff8e1;
        }
        
        .editable-value {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .editable-value:hover {
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        
        /* Add styles for locked rate fields */
        .editable-rate {
            padding: 3px 5px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .editable-rate:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .locked-rate {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            padding: 3px 5px;
            border-radius: 3px;
        }
        
        .rate-locked-indicator {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.12.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- Tab Navigation -->
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'currencyConverter')">Currency Converter</button>
            <button class="tablinks" onclick="openTab(event, 'tomCalculator')">TOM Calculator</button>
        </div>
        
        <!-- Currency Converter Tab -->
        <div id="currencyConverter" class="tabcontent" style="display: block;">
            <h2>Multi-Currency Converter</h2>
            
            <!-- New Exchange Rate Configuration Table -->
            <div class="config-container">
                <h3>Current Visa Exchange Rates <small>(click to edit)</small></h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>1 USD =</div>
                    <button class="save-btn" onclick="resetToAPIRates()">Reset to Visa Rates</button>
                </div>
                <table id="ratesTable" style="max-width: 600px; margin: 0 auto;">
                    <thead>
                        <tr>
                            <th>Chinese RMB (CNY)</th>
                            <th>Hong Kong Dollar (HKD)</th>
                            <th>Japanese Yen (JPY)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="editable-rate" data-currency="CNY">Loading...</span></td>
                            <td><span class="editable-rate" data-currency="HKD">Loading...</span></td>
                            <td><span class="editable-rate" data-currency="JPY">Loading...</span></td>
                        </tr>
                    </tbody>
                </table>
                <div style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #666;">
                    Using Visa's exchange rates instead of real-time market rates to match credit card charges.
                </div>
                <div id="rateLockedIndicator" class="rate-locked-indicator" style="text-align: center;">
                    <i>Rates are locked. Click "Reset to Visa Rates" to unlock and edit other rates.</i>
                </div>
            </div>
            
            <div id="calculationResult" style="color: red; text-align: center; margin-bottom: 10px; min-height: 20px;"></div>
            
            <div class="table-container">
                <table id="conversionTable">
                    <thead>
                        <tr>
                            <th>USD</th>
                            <th>Chinese RMB</th>
                            <th>Hong Kong Dollar</th>
                            <th>Japanese Yen</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="inputRow">
                            <td><input type="text" id="usd" placeholder="Enter USD" oninput="convertCurrency('USD')"></td>
                            <td><input type="text" id="rmb" placeholder="Enter RMB" oninput="convertCurrency('CNY')"></td>
                            <td><input type="text" id="hkd" placeholder="Enter HKD" oninput="convertCurrency('HKD')"></td>
                            <td><input type="text" id="yen" placeholder="Enter Yen" oninput="convertCurrency('JPY')"></td>
                            <td><button class="save-btn" onclick="saveCurrentConversion()">Save</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- TOM Calculator Tab -->
        <div id="tomCalculator" class="tabcontent">
            <h2>TOM Calculator</h2>
            
            <div class="config-container">
                <h3>Configuration</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <label>CC Cashback:</label>
                        <input type="number" id="ccCashback" value="3" min="0" max="100" step="0.01" style="width: 80px;" oninput="calculateTOMPrices()"> %
                    </div>
                    <div>
                        <label>TOM Cashback (This Product):</label>
                        <input type="number" id="tomCashbackThis" value="25" min="0" max="100" step="0.01" style="width: 80px;" oninput="calculateTOMPrices()"> %
                    </div>
                    <div>
                        <label>TOM Cashback (Future Product):</label>
                        <input type="number" id="tomCashbackFuture" value="25" min="0" max="100" step="0.01" style="width: 80px;" oninput="calculateTOMPrices()"> %
                    </div>
                </div>
            </div>
            
            <div>
                <label for="tomUsd"><strong>Product Price (USD):</strong></label>
                <input type="text" id="tomUsd" placeholder="Enter USD" style="width: 200px;" oninput="calculateTOMPrices()">
                <div id="tomCalculationResult" style="color: red; display: inline-block; margin-left: 10px;"></div>
            </div>
            
            <div class="formula-display">
                <h3>Formulas</h3>
                <div id="inStockFormulaContainer">
                    <strong>IN Stock:</strong> 
                    <span id="priceValue" class="editable-value" style="color: #2ecc71; font-weight: bold;">$0.00</span> × 
                    (1 - <span id="ccCashbackValue" class="editable-value" style="color: #e74c3c; font-weight: bold;">5.25%</span> - 
                    (<span id="tomThisValue" class="editable-value" style="color: #3498db; font-weight: bold;">25.00%</span> × 
                    (1 - <span id="inStockFutureValue" style="color: #9b59b6; font-weight: bold;">5.00%</span>)))
                    = <span id="inStockResult">$0.00</span>
                </div>
                <div id="preOrderFormulaContainer" style="margin-top: 10px;">
                    <strong>Pre Order:</strong> 
                    <span class="priceValue editable-value" style="color: #2ecc71; font-weight: bold;">$0.00</span> × 
                    (1 - <span class="ccCashbackValue editable-value" style="color: #e74c3c; font-weight: bold;">5.25%</span> - 
                    (<span class="tomThisValue editable-value" style="color: #3498db; font-weight: bold;">25.00%</span> × 
                    (1 - <span id="tomFutureValue" class="editable-value" style="color: #9b59b6; font-weight: bold;">25.00%</span>)))
                    = <span id="preOrderResult">$0.00</span>
                </div>
            </div>
            
            <div class="table-container">
                <table id="tomCalculatorTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>USD</th>
                            <th>Chinese RMB</th>
                            <th>Hong Kong Dollar</th>
                            <th>Japanese Yen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="inStockRow" class="in-stock-row">
                            <td>IN Stock</td>
                            <td id="inStockUsd">-</td>
                            <td id="inStockRmb">-</td>
                            <td id="inStockHkd">-</td>
                            <td id="inStockYen">-</td>
                        </tr>
                        <tr id="preOrderRow" class="pre-order-row">
                            <td>Pre Order</td>
                            <td id="preOrderUsd">-</td>
                            <td id="preOrderRmb">-</td>
                            <td id="preOrderHkd">-</td>
                            <td id="preOrderYen">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==============================================
        // CONSTANTS AND GLOBAL STATE
        // ==============================================
        const CURRENCY_SYMBOLS = {
            'USD': '$',
            'CNY': '¥',
            'HKD': 'HK$',
            'JPY': '¥'
        };
        
        const CURRENCY_TO_INPUT_MAP = {
            'USD': 'usd',
            'CNY': 'rmb',
            'HKD': 'hkd',
            'JPY': 'yen'
        };
        
        const INPUT_TO_CURRENCY_MAP = {
            'usd': 'USD',
            'rmb': 'CNY',
            'hkd': 'HKD',
            'yen': 'JPY'
        };
        
        // Application state
        let rates = {};
        let manualRates = {};
        let usingManualRates = false;
        let lastEditedRateCurrency = null;
        
        // ==============================================
        // UI CONTROL FUNCTIONS
        // ==============================================
        
        // Tab functionality
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tablinks').forEach(link => link.classList.remove('active'));
            
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        // ==============================================
        // EXCHANGE RATE FUNCTIONS
        // ==============================================
        
        // Fetch current Visa exchange rates
        async function fetchRates() {
            try {
                const todayDate = new Date();
                const formattedDate = `${(todayDate.getMonth() + 1).toString().padStart(2, '0')}/${todayDate.getDate().toString().padStart(2, '0')}/${todayDate.getFullYear()}`;
                
                const results = {};
                const currencies = ['CNY', 'HKD', 'JPY'];
                
                // Fetch each currency rate in parallel
                const promises = currencies.map(async (currency) => {
                    const url = "https://usa.visa.com/cmsapi/fx/rates";
                    const params = {
                        amount: 1,
                        fee: 0,
                        utcConvertedDate: formattedDate,
                        exchangedate: formattedDate,
                        fromCurr: "USD",
                        toCurr: currency
                    };
                    
                    const headers = {
                        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36",
                        "Accept": "application/json, text/plain, */*",
                        "Accept-Language": "en-US,en;q=0.9",
                        "Origin": "https://usa.visa.com",
                        "Referer": "https://usa.visa.com/support/consumer/travel-support/exchange-rate-calculator.html",
                        "Sec-Fetch-Dest": "empty",
                        "Sec-Fetch-Mode": "cors",
                        "Sec-Fetch-Site": "same-origin",
                        "Connection": "keep-alive"
                    };
                    
                    try {
                        const response = await axios.get(url, { params, headers });
                        results[currency] = parseFloat(response.data.reverseAmount);
                        console.log(`1 USD = ${results[currency]} ${currency}`);
                    } catch (err) {
                        console.error(`Error fetching ${currency} rate:`, err);
                        // Fallback values if API call fails
                        results[currency] = currency === 'CNY' ? 7.2 : 
                                          currency === 'HKD' ? 7.8 : 150.0; // JPY
                        
                        document.getElementById('calculationResult').textContent = 
                            "CORS error or network issue with Visa API. Using default rates.";
                    }
                });
                
                try {
                    await Promise.all(promises);
                } catch (error) {
                    console.error('Error in Promise.all:', error);
                }
                
                rates = { ...results, 'USD': 1 };
                updateRatesDisplay();
                return rates;
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                document.getElementById('calculationResult').textContent = 
                    "Error fetching Visa exchange rates. Using default values.";
                rates = { 'CNY': 7.2, 'HKD': 7.8, 'JPY': 150.0, 'USD': 1 };
                updateRatesDisplay();
                return rates;
            }
        }
        
        // Update the display of current rates
        function updateRatesDisplay() {
            const displayRates = usingManualRates ? manualRates : rates;
            
            document.querySelectorAll('.editable-rate, .locked-rate').forEach(el => {
                const currency = el.getAttribute('data-currency') || el.getAttribute('data-original-currency');
                if (displayRates[currency]) {
                    el.textContent = displayRates[currency].toFixed(4);
                }
            });
            
            // Show/hide locked indicator
            document.getElementById('rateLockedIndicator').style.display = 
                usingManualRates ? 'block' : 'none';
            
            // Update rate cell styles
            updateRateCellStyles();
        }
        
        // Update rate cell styles based on locked status
        function updateRateCellStyles() {
            document.querySelectorAll('.editable-rate, .locked-rate').forEach(el => {
                if (usingManualRates) {
                    // Convert to locked style
                    el.className = 'locked-rate';
                    el.title = 'Rate locked. Click "Reset to Visa Rates" to unlock.';
                } else {
                    // Convert to editable style
                    el.className = 'editable-rate';
                    el.title = 'Click to edit rate';
                    
                    // Restore data-currency attribute if needed
                    if (!el.hasAttribute('data-currency')) {
                        const currency = el.getAttribute('data-original-currency');
                        if (currency) {
                            el.setAttribute('data-currency', currency);
                        }
                    }
                }
            });
        }
        
        // Setup rate editing functionality
        function setupEditableRates() {
            document.querySelectorAll('.editable-rate').forEach(el => {
                // Store original currency for reference
                const currency = el.getAttribute('data-currency');
                el.setAttribute('data-original-currency', currency);
                
                el.addEventListener('click', function() {
                    // Only allow editing if rates are not manually set (locked)
                    if (usingManualRates) {
                        document.getElementById('calculationResult').textContent = 
                            "Rates are locked. Click 'Reset to Visa Rates' to unlock.";
                        return;
                    }
                    
                    const currency = this.getAttribute('data-currency');
                    const currentValue = rates[currency];
                    
                    // Create temporary input for editing
                    const tempInput = document.createElement('input');
                    tempInput.type = 'number';
                    tempInput.step = '0.0001';
                    tempInput.min = '0';
                    tempInput.value = currentValue.toFixed(4);
                    tempInput.style.width = '80px';
                    tempInput.style.padding = '2px';
                    
                    this.parentNode.replaceChild(tempInput, this);
                    tempInput.focus();
                    
                    // Handle blur and enter key
                    tempInput.addEventListener('blur', () => updateRateFromInput(tempInput, el, currency));
                    tempInput.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            updateRateFromInput(tempInput, el, currency);
                        }
                    });
                });
            });
        }
        
        // Process rate input and update display
        function updateRateFromInput(input, originalEl, currency) {
            const newRate = parseFloat(input.value);
            if (!isNaN(newRate) && newRate > 0) {
                // Initialize manual rates from API rates if first edit
                if (!usingManualRates) {
                    manualRates = {...rates};
                    usingManualRates = true;
                }
                
                // Track which currency rate was last edited
                lastEditedRateCurrency = currency;
                
                // Update rate and display
                manualRates[currency] = newRate;
                originalEl.textContent = newRate.toFixed(4);
                document.getElementById('calculationResult').textContent = 
                    `Updated ${currency} rate to ${newRate.toFixed(4)}. All rates are now locked.`;
                
                // Lock all rate cells
                updateRateCellStyles();
                
                // Handle currency conversion with the new rate
                performConversionWithNewRate(currency);
            } else {
                // Restore original on invalid input
                originalEl.textContent = (usingManualRates ? manualRates[currency] : rates[currency]).toFixed(4);
                document.getElementById('calculationResult').textContent = "Invalid rate entered.";
            }
            
            // Replace the input with the original element
            input.parentNode.replaceChild(originalEl, input);
        }
        
        // Perform conversion after rate change
        function performConversionWithNewRate(currency) {
            // Get input values
            const inputIds = CURRENCY_TO_INPUT_MAP;
            const inputElement = document.getElementById(inputIds[currency]);
            
            // If the currency whose rate changed has a value, use that for conversion
            if (inputElement.value && inputElement.value.trim() !== '') {
                convertCurrency(currency);
                return;
            }
            
            // Otherwise find any foreign currency with a value to keep fixed
            for (const curr of ['CNY', 'HKD', 'JPY']) {
                const el = document.getElementById(CURRENCY_TO_INPUT_MAP[curr]);
                if (el.value && el.value.trim() !== '') {
                    convertCurrency(curr);
                    return;
                }
            }
            
            // If no foreign currency has a value, use USD if available
            const usdElement = document.getElementById('usd');
            if (usdElement.value && usdElement.value.trim() !== '') {
                convertCurrency('USD');
            }
        }
        
        // Reset to API rates
        function resetToAPIRates() {
            // 1. Identify which currency value to keep fixed
            const inputValues = {
                'USD': document.getElementById('usd').value,
                'CNY': document.getElementById('rmb').value,
                'HKD': document.getElementById('hkd').value,
                'JPY': document.getElementById('yen').value
            };
            
            let fixedCurrency = null;
            let fixedInputId = null;
            let fixedValue = null;
            
            // First check if we have a value for the last edited rate currency
            if (lastEditedRateCurrency && 
                inputValues[lastEditedRateCurrency] && 
                inputValues[lastEditedRateCurrency].trim() !== '') {
                fixedCurrency = lastEditedRateCurrency;
                fixedInputId = CURRENCY_TO_INPUT_MAP[lastEditedRateCurrency];
                fixedValue = inputValues[lastEditedRateCurrency];
            } else {
                // Check all inputs to find any with values
                const inputsWithValues = [];
                
                for (const [currency, value] of Object.entries(inputValues)) {
                    if (value && value.trim() !== '') {
                        inputsWithValues.push({
                            currency,
                            id: CURRENCY_TO_INPUT_MAP[currency],
                            value
                        });
                    }
                }
                
                // If we have any inputs with values, use the first one
                if (inputsWithValues.length > 0) {
                    fixedCurrency = inputsWithValues[0].currency;
                    fixedInputId = inputsWithValues[0].id;
                    fixedValue = inputsWithValues[0].value;
                }
            }
            
            // 2. IMMEDIATELY update UI to clear all fields except fixed one
            for (const id of Object.values(CURRENCY_TO_INPUT_MAP)) {
                if (id !== fixedInputId) {
                    document.getElementById(id).value = '';
                }
            }
            
            // 3. Reset rate state
            usingManualRates = false;
            updateRateCellStyles();
            lastEditedRateCurrency = null;
            
            // 4. API call and post-processing
            if (!fixedCurrency) {
                fetchRates().then(() => {
                    document.getElementById('calculationResult').textContent = 
                        "Reset to Visa exchange rates. All rates are now editable.";
                });
                return;
            }
            
            // With fixed value, fetch rates and then convert
            document.getElementById('calculationResult').textContent = 
                `Resetting rates, keeping ${fixedCurrency} fixed...`;
                
            fetchRates().then(() => {
                document.getElementById('calculationResult').textContent = 
                    `Reset to Visa exchange rates. Keeping ${fixedCurrency} fixed at ${fixedValue}.`;
                
                // Ensure fixed value is preserved
                document.getElementById(fixedInputId).value = fixedValue;
                
                // Perform conversion
                convertCurrency(fixedCurrency);
            }).catch(err => {
                console.error("Error fetching rates:", err);
                document.getElementById('calculationResult').textContent = 
                    "Error resetting rates. Please try again.";
            });
        }

        // ==============================================
        // CURRENCY CONVERSION FUNCTIONS
        // ==============================================
        
        // Main currency conversion function
        async function convertCurrency(currency) {
            // Ensure rates are loaded
            if (Object.keys(rates).length === 0) {
                await fetchRates();
            }

            // Get input elements
            const inputs = {};
            for (const [curr, id] of Object.entries(CURRENCY_TO_INPUT_MAP)) {
                inputs[curr] = document.getElementById(id);
            }
            
            const resultDisplay = document.getElementById('calculationResult');
            const sourceInput = inputs[currency];
            const currentRates = usingManualRates ? manualRates : rates;

            try {
                // Handle empty input
                if (!sourceInput.value || sourceInput.value.trim() === '') {
                    Object.values(inputs).forEach(input => input.value = '');
                    resultDisplay.textContent = '';
                    return;
                }
                
                // Save original value to preserve exact format
                const originalValue = sourceInput.value;
                
                // Parse input value
                const sourceValue = math.evaluate(originalValue.replace(/,/g, ''));
                
                if (isNaN(sourceValue) || sourceValue <= 0) {
                    throw new Error('Invalid number');
                }
                
                // Show calculation result for expressions
                if (originalValue.match(/[+\-*/]/)) {
                    resultDisplay.textContent = `${originalValue} = ${CURRENCY_SYMBOLS[currency]}${sourceValue.toFixed(2)} ${currency}`;
                }
                
                // Clear all inputs except source to prevent flickering
                for (const [curr, input] of Object.entries(inputs)) {
                    if (curr !== currency) {
                        input.value = '';
                    }
                }
                
                // CORE CONVERSION LOGIC
                if (currency === 'USD') {
                    // USD to foreign currencies
                    for (const targetCurrency of ['CNY', 'HKD', 'JPY']) {
                        inputs[targetCurrency].value = (sourceValue * currentRates[targetCurrency]).toFixed(2);
                    }
                } else {
                    // Foreign currency to USD first
                    const usdValue = sourceValue / currentRates[currency];
                    inputs['USD'].value = usdValue.toFixed(2);
                    
                    // USD to other foreign currencies
                    for (const targetCurrency of ['CNY', 'HKD', 'JPY']) {
                        if (targetCurrency !== currency) {
                            inputs[targetCurrency].value = (usdValue * currentRates[targetCurrency]).toFixed(2);
                        }
                    }
                }
                
                // Ensure original value is preserved exactly
                sourceInput.value = originalValue;
                
            } catch (e) {
                console.error("Conversion error:", e);
                resultDisplay.textContent = "Invalid expression";
                
                // Clear other fields on error
                for (const [curr, input] of Object.entries(inputs)) {
                    if (curr !== currency) {
                        input.value = '';
                    }
                }
            }
        }

        // Save current conversion to table
        function saveCurrentConversion() {
            const inputs = {
                'usd': document.getElementById('usd').value,
                'rmb': document.getElementById('rmb').value,
                'hkd': document.getElementById('hkd').value,
                'yen': document.getElementById('yen').value
            };

            // Don't save if all fields are empty
            if (Object.values(inputs).every(value => !value)) return;

            // Create a new row
            const table = document.getElementById('conversionTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow(table.rows.length - 1);
            newRow.className = 'saved-row';

            // Add cells with evaluated values
            ['usd', 'rmb', 'hkd', 'yen'].forEach(field => {
                const cell = newRow.insertCell();
                try {
                    if (inputs[field] && inputs[field].match(/[+\-*/]/)) {
                        const result = math.evaluate(inputs[field].replace(/,/g, ''));
                        cell.textContent = result.toFixed(2);
                    } else {
                        cell.textContent = inputs[field] || '';
                    }
                } catch (e) {
                    cell.textContent = inputs[field] || ''; // Use original if evaluation fails
                }
            });

            // Add empty cell for action column
            newRow.insertCell();

            // Clear input fields and result display
            ['usd', 'rmb', 'hkd', 'yen'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('calculationResult').textContent = '';
        }

        // ==============================================
        // TOM CALCULATOR FUNCTIONS
        // ==============================================
        
        // Calculate TOM prices
        function calculateTOMPrices() {
            if (Object.keys(rates).length === 0) {
                fetchRates().then(() => performTOMCalculation());
            } else {
                performTOMCalculation();
            }
        }

        // Perform TOM calculation after rates are available
        function performTOMCalculation() {
            const tomUsdInput = document.getElementById('tomUsd');
            const resultDisplay = document.getElementById('tomCalculationResult');
            const currentRates = usingManualRates ? manualRates : rates;
            
            try {
                // Get configuration values
                const ccCashback = parseFloat(document.getElementById('ccCashback').value) / 100;
                const tomCashbackThis = parseFloat(document.getElementById('tomCashbackThis').value) / 100;
                const tomCashbackFuture = parseFloat(document.getElementById('tomCashbackFuture').value) / 100;
                const inStockFutureCashback = 0.05; // Fixed 5% future cashback for in-stock items
                
                // Get and evaluate product price
                let productPrice = 0;
                if (tomUsdInput.value) {
                    productPrice = math.evaluate(tomUsdInput.value.replace(/,/g, ''));
                }
                
                if (isNaN(productPrice)) {
                    throw new Error('Invalid product price');
                }
                
                // Calculate prices with different cashback scenarios
                const preOrderPrice = productPrice * (1 - ccCashback - (tomCashbackThis * (1 - tomCashbackFuture)));
                const inStockPrice = productPrice * (1 - ccCashback - (tomCashbackThis * (1 - inStockFutureCashback)));
                
                // Update UI with results
                updateTOMResultsTable(inStockPrice, preOrderPrice, currentRates);
                
                // Show calculation for expressions
                if (tomUsdInput.value.match(/[+\-*/]/)) {
                    resultDisplay.textContent = `${tomUsdInput.value} = $${productPrice.toFixed(2)} USD`;
                } else {
                    resultDisplay.textContent = '';
                }
                
                // Update formula display
                updateFormulaDisplay(productPrice, ccCashback, tomCashbackThis, tomCashbackFuture, 
                                    inStockFutureCashback, inStockPrice, preOrderPrice);
                
            } catch (e) {
                resultDisplay.textContent = "Invalid expression";
            }
        }
        
        // Update TOM results table with calculated prices
        function updateTOMResultsTable(inStockPrice, preOrderPrice, currentRates) {
            // Update USD values
            document.getElementById('inStockUsd').textContent = '$' + inStockPrice.toFixed(2);
            document.getElementById('preOrderUsd').textContent = '$' + preOrderPrice.toFixed(2);
            
            // Update other currencies
            const currencies = [
                { code: 'CNY', prefix: '¥', elements: ['inStockRmb', 'preOrderRmb'] },
                { code: 'HKD', prefix: 'HK$', elements: ['inStockHkd', 'preOrderHkd'] },
                { code: 'JPY', prefix: '¥', elements: ['inStockYen', 'preOrderYen'] }
            ];
            
            currencies.forEach(currency => {
                document.getElementById(currency.elements[0]).textContent = 
                    currency.prefix + (inStockPrice * currentRates[currency.code]).toFixed(2);
                document.getElementById(currency.elements[1]).textContent = 
                    currency.prefix + (preOrderPrice * currentRates[currency.code]).toFixed(2);
            });
        }
        
        // Update the formula display in TOM calculator
        function updateFormulaDisplay(price, ccCashback, tomCashbackThis, tomCashbackFuture, 
                                     inStockFutureCashback, inStockPrice, preOrderPrice) {
            // Update price displays
            document.getElementById('priceValue').textContent = '$' + price.toFixed(2);
            document.querySelectorAll('.priceValue').forEach(el => {
                el.textContent = '$' + price.toFixed(2);
            });
            
            // Update cashback percentages
            document.getElementById('ccCashbackValue').textContent = (ccCashback * 100).toFixed(2) + '%';
            document.querySelectorAll('.ccCashbackValue').forEach(el => {
                el.textContent = (ccCashback * 100).toFixed(2) + '%';
            });
            
            document.getElementById('tomThisValue').textContent = (tomCashbackThis * 100).toFixed(2) + '%';
            document.querySelectorAll('.tomThisValue').forEach(el => {
                el.textContent = (tomCashbackThis * 100).toFixed(2) + '%';
            });
            
            document.getElementById('tomFutureValue').textContent = (tomCashbackFuture * 100).toFixed(2) + '%';
            document.getElementById('inStockFutureValue').textContent = (inStockFutureCashback * 100).toFixed(2) + '%';
            
            // Update formula results
            document.getElementById('inStockResult').textContent = '$' + inStockPrice.toFixed(2);
            document.getElementById('preOrderResult').textContent = '$' + preOrderPrice.toFixed(2);
        }
        
        // Set up editable values in formulas
        function setupEditableValue(spanId, inputId) {
            const span = document.getElementById(spanId);
            
            span.addEventListener('click', function() {
                const value = span.textContent.replace(/[^0-9.]/g, '');
                const tempInput = document.createElement('input');
                tempInput.type = spanId === 'priceValue' ? 'text' : 'number';
                tempInput.value = value;
                tempInput.style.width = '80px';
                tempInput.style.padding = '2px';
                tempInput.style.border = '1px solid #ccc';
                tempInput.style.borderRadius = '3px';
                tempInput.style.fontSize = '14px';
                tempInput.style.fontFamily = 'monospace';
                
                // If percentage input, add attributes
                if (spanId !== 'priceValue') {
                    tempInput.min = '0';
                    tempInput.max = '100';
                    tempInput.step = '0.01';
                }
                
                span.parentNode.replaceChild(tempInput, span);
                tempInput.focus();
                
                // Set up blur and enter key handlers
                tempInput.addEventListener('blur', () => updateValueFromTempInput(tempInput, span, inputId));
                tempInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        updateValueFromTempInput(tempInput, span, inputId);
                    }
                });
            });
        }
        
        // Update formula values from input
        function updateValueFromTempInput(tempInput, originalSpan, inputId) {
            try {
                const value = tempInput.type === 'text' ? 
                    math.evaluate(tempInput.value.replace(/,/g, '')) : 
                    parseFloat(tempInput.value);
                
                if (isNaN(value)) {
                    throw new Error('Invalid number');
                }
                
                // Update the corresponding input in the config section
                document.getElementById(inputId).value = value;
                
                // Format display based on input type
                if (inputId === 'tomUsd') {
                    originalSpan.textContent = '$' + value.toFixed(2);
                    document.querySelectorAll('.priceValue').forEach(el => {
                        el.textContent = '$' + value.toFixed(2);
                    });
                } else {
                    originalSpan.textContent = value.toFixed(2) + '%';
                    const className = inputId === 'ccCashback' ? 'ccCashbackValue' : 
                        (inputId === 'tomCashbackThis' ? 'tomThisValue' : 'tomFutureValue');
                    document.querySelectorAll('.' + className).forEach(el => {
                        el.textContent = value.toFixed(2) + '%';
                    });
                }
                
                // Recalculate prices
                calculateTOMPrices();
            } catch (e) {
                console.error("Invalid input:", e);
            }
            
            tempInput.parentNode.replaceChild(originalSpan, tempInput);
        }

        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize exchange rates
            fetchRates().then(() => {
                document.getElementById('calculationResult').textContent = "Using Visa exchange rates for currency conversion.";
                setTimeout(() => {
                    document.getElementById('calculationResult').textContent = "";
                }, 3000);
            });
            
            // Set up UI interaction handlers
            setupEditableRates();
            
            // Set up TOM calculator editable values
            setupEditableValue('priceValue', 'tomUsd');
            setupEditableValue('ccCashbackValue', 'ccCashback');
            setupEditableValue('tomThisValue', 'tomCashbackThis');
            setupEditableValue('tomFutureValue', 'tomCashbackFuture');
            
            // Initialize mirror classes for formula values
            document.querySelectorAll('.priceValue').forEach(el => {
                if (el.id !== 'priceValue') {
                    el.textContent = document.getElementById('priceValue').textContent;
                }
            });
            document.querySelectorAll('.ccCashbackValue').forEach(el => {
                if (el.id !== 'ccCashbackValue') {
                    el.textContent = document.getElementById('ccCashbackValue').textContent;
                }
            });
            document.querySelectorAll('.tomThisValue').forEach(el => {
                if (el.id !== 'tomThisValue') {
                    el.textContent = document.getElementById('tomThisValue').textContent;
                }
            });
        });
    </script>
</body>
</html>

